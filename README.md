# RISC-V 操作系统实验项目

本项目基于 **RISC-V 架构**，在 QEMU 模拟器上实现了一系列操作系统核心机制实验，涵盖 **启动流程、内存管理、中断异常、进程调度、系统调用、文件系统以及优先级调度** 等内容。
所有实验均以模块化方式组织，支持按实验编号独立运行，便于调试与验证。

---

## 一、项目运行环境

* **体系结构**：RISC-V 64
* **模拟器**：QEMU（qemu-riscv64）
* **编译工具链**：riscv64-unknown-elf-gcc
* **宿主系统**：Linux（Ubuntu 22.04 测试通过）

---

## 二、项目目录说明

```
├── include               # 头文件目录，存放全局宏、结构体和函数声明
│   ├── assert.h          # 断言宏，用于调试
│   ├── def.h             # 系统全局常量、类型定义
│   ├── memlayout.h       # 内存布局相关宏与结构
│   ├── riscv.h           # RISC-V 架构相关定义
│   ├── syscall.h         # 系统调用编号与接口声明
│   └── virtio.h          # VirtIO 虚拟磁盘驱动相关结构与函数
├── kernel                # 内核源代码目录
│   ├── boot              # 启动相关代码
│   │   ├── entry.S       # 启动汇编入口
│   │   ├── sbi.c         # 与 RISC-V SBI (Supervisor Binary Interface) 交互
│   │   └── start.c       # 内核初始化入口
│   ├── fs                # 文件系统相关
│   │   ├── bio.c         # 块缓存管理
│   │   ├── file.c        # 文件操作接口实现
│   │   ├── fs.c          # 文件系统核心功能（inode、目录等）
│   │   ├── log.c         # 写前日志（WAL）实现
│   │   ├── sysfile.c     # 文件系统系统调用接口
│   │   └── virtio_disk.c # VirtIO 磁盘读写接口
│   ├── lib               # 内核库函数
│   │   ├── console.c     # 控制台输入输出
│   │   ├── printf.c      # 格式化打印实现
│   │   ├── snprintf.c    # 字符串格式化函数
│   │   ├── string.c      # 基本字符串操作函数
│   │   └── uart.c        # UART 驱动
│   ├── mm                # 内存管理
│   │   ├── kalloc.c      # 内核页分配器
│   │   └── vm.c          # 虚拟内存与页表管理
│   ├── net               # 网络模块（简化或未实现）
│   ├── proc              # 进程管理
│   │   ├── proc.c        # 进程核心调度与管理
│   │   ├── swtch.S       # 上下文切换汇编实现
│   │   ├── swtest.c      # 上下文切换测试
│   │   └── sysproc.c     # 进程相关系统调用接口
│   ├── sync              # 同步原语
│   │   ├── sleeplock.c   # 睡眠锁实现
│   │   └── spinlock.c    # 自旋锁实现
│   └── trap              # 异常与中断处理
│       ├── kernelvec.S   # 内核异常向量
│       ├── trampoline.S  # 用户态与内核态切换 trampolines
│       └── trap.c        # 中断/异常处理逻辑
├── Makefile              # 编译规则
├── mkfs                  # 文件系统镜像生成工具
│   ├── mkfs              # 可执行文件
│   └── mkfs.c            # 源代码实现
├── readme.md             # 项目说明文档
└── scripts               # 构建与辅助脚本
    ├── kernel.ld         # 内核链接脚本
    ├── usys.pl           # 系统调用生成脚本
    └── usys.S            # 系统调用汇编接口
```

---

## 三、实验列表说明

本项目共包含 **8 个实验**，每个实验对应一个独立的测试入口函数：

| 实验编号 | 实验内容           |
| ---- | -------------- |
| Lab1 | 串口输出与内核启动验证    |
| Lab2 | printf 实现与边界测试 |
| Lab3 | 物理内存与虚拟内存管理    |
| Lab4 | 时钟中断与异常处理      |
| Lab5 | 进程创建、调度与同步     |
| Lab6 | 系统调用机制         |
| Lab7 | 文件系统与日志恢复      |
| Lab8 | 扩展实验：优先级调度系统   |

---

## 四、运行方式

### 1️⃣ 选择要运行的实验

在 `kernel/boot/start.c` 文件中，找到 `main` 函数，选择要运行的实验：

```c
void main() {
    //lab1_test();
    //lab2_test();
    //lab3_test();
    //lab4_test();
    //lab5_test();
    //lab6_test();
    //lab7_test();
    lab8_test();
}
```
---

### 2️⃣ 编译并运行

在项目根目录下执行：

```bash
make qemu
```

系统将自动完成以下流程：

1. 编译内核代码
2. 启动 QEMU（RISC-V）
3. 加载内核并执行指定实验
4. 在终端输出实验运行结果

---

## 五、输出说明

* 实验运行过程中，所有关键步骤均通过 `printf` 输出
* 不同实验会输出不同的测试日志，例如：

  * 中断触发次数
  * 进程调度顺序
  * 文件读写结果
  * 崩溃恢复前后数据变化
* 若实验正常结束，会输出对应的 **test passed / completed** 信息

---

## 六、注意事项

* 请确保已正确安装 **riscv64-unknown-elf-gcc** 工具链
* QEMU 版本建议 ≥ 7.0
* 实验之间可能依赖不同的子系统初始化，请勿混合调用多个实验函数
* 若出现异常退出，可通过修改实验编号单独调试对应实验

---

## 七、扩展与改进方向

* 支持命令行参数动态选择实验
* 引入自动化测试脚本
* 扩展多级反馈队列（MLFQ）调度器
* 增强文件系统性能与缓存策略

---

## 八、说明

本项目用于操作系统原理与内核实现相关实验，重点在于**理解内核机制与实现思路**，而非完整工业级系统。

---

如果你愿意，我可以帮你再做一件非常“加分”的事：
👉 **把 README 改成课程实验报告附录风格** 或
👉 **给你补一版英文 README（课程/开源仓库通用）**
